<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Játékos Adminisztráció</title>
    <!-- Tailwind CSS betöltése -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Egyedi stílusok */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container-box {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 900px;
        }
        .table-header {
            background-color: #4f46e5;
            color: white;
        }
    </style>
    <script>
        // --- KONSTANS ---
        const BACKEND_API_URL = "/players";
        const WEBSOCKET_URL = "ws://localhost:8080/ws/players";

        // Globális WebSocket objektum a kapcsolat kezeléséhez
        let ws;
        // Globális lista az adatok tárolására, amit a WS események frissítenek
        let playersData = [];

        /**
         * Inicializálás: Betölti a játékoslistát és elindítja a WebSocket kapcsolatot.
         */
        async function fetchPlayers() {
            const statusEl = document.getElementById('status');
            const playerTableBodyEl = document.getElementById('playerTableBody');

            if (!statusEl || !playerTableBodyEl) {
                console.error("DOM elemek hiányoznak, leállítom a betöltést.");
                return;
            }

            statusEl.textContent = 'Betöltés...';
            statusEl.className = 'text-center text-blue-600 my-4';

            try {
                const response = await fetch(BACKEND_API_URL);

                if (!response.ok) {
                    throw new Error(`HTTP hiba: ${response.status} (${response.statusText})`);
                }

                playersData = await response.json(); // Frissítjük a globális listát
                renderPlayers(playersData); // Megjelenítjük
                statusEl.textContent = `Sikeresen betöltve: ${playersData.length} játékos.`;
                statusEl.className = 'text-center text-green-600 my-4';

            } catch (error) {
                console.error("Hiba az adatok lekérdezésekor:", error);
                statusEl.textContent = `Hiba a szerverrel való kommunikáció során: ${error.message}. Ellenőrizze, hogy a Ktor szerver fut-e.`;
                statusEl.className = 'text-center text-red-600 my-4 font-bold';
            }
        }

        // ----------------------------------------------------------------------
        // WebSocket és eseménykezelés
        // ----------------------------------------------------------------------

        /**
         * Esemény kezelése (frissítés, törlés, hozzáadás) a WS-ről érkező üzenet alapján.
         */
        function handleEvent(eventData) {
            console.log("WS Event received:", eventData.type, eventData);

            switch (eventData.type) {
                case 'PlayerAdded':
                    // Ellenőrizzük, hogy az ID már létezik-e (elkerüljük a duplikációt)
                    if (!playersData.find(p => p.id === eventData.player.id)) {
                        playersData = [...playersData, eventData.player];
                    }
                    // Mivel a Ktor mindig broadcastol, még a saját POST kérésünkre is,
                    // a listát frissítjük a WS alapján.
                    break;

                case 'PlayerDeleted':
                    // Kiszűrjük a törölt elemet az ID alapján
                    playersData = playersData.filter(p => p.id !== eventData.id);
                    // Kiírjuk a törlés tényét
                    document.getElementById('status').textContent = `Játékos ${eventData.id} törölve a WS-en keresztül.`;
                    document.getElementById('status').className = 'text-center text-orange-600 my-4';
                    break;

                default:
                    console.warn("Ismeretlen WS esemény típus:", eventData.type);
            }

            // Minden frissítés után újra rendereljük a táblázatot
            renderPlayers(playersData);
        }

        /**
         * Létrehozza és kezeli a WebSocket kapcsolatot
         */
        function setupWebSocket() {
            if (ws) {
                ws.close();
            }
            ws = new WebSocket(WEBSOCKET_URL);

            ws.onopen = () => {
                console.log("WebSocket kapcsolat létrejött.");
                document.getElementById('wsStatus').textContent = 'Csatlakozva';
                document.getElementById('wsStatus').className = 'inline-flex items-center rounded-full bg-green-100 px-3 py-0.5 text-sm font-medium text-green-800';
            };

            ws.onmessage = (event) => {
                try {
                    const eventData = JSON.parse(event.data);
                    handleEvent(eventData);
                } catch (e) {
                    console.error("Hiba a WS üzenet dekódolásakor:", e);
                }
            };

            ws.onclose = () => {
                console.warn("WebSocket kapcsolat megszakadt. Újracsatlakozás 5 másodperc múlva...");
                document.getElementById('wsStatus').textContent = 'Kapcsolat megszakadt. Újracsatlakozás...';
                document.getElementById('wsStatus').className = 'inline-flex items-center rounded-full bg-red-100 px-3 py-0.5 text-sm font-medium text-red-800';
                setTimeout(setupWebSocket, 5000); // 5 másodperc után próbálja újra
            };

            ws.onerror = (error) => {
                console.error("WebSocket hiba:", error);
                ws.close();
            };
        }

        // ----------------------------------------------------------------------
        // CRUD Műveletek
        // ----------------------------------------------------------------------

        /**
         * Játékos hozzáadása POST kéréssel.
         */
        async function addPlayer(event) {
            event.preventDefault();

            const form = document.getElementById('addPlayerForm');
            const statusEl = document.getElementById('status');

            const nameInput = document.getElementById('playerName').value.trim();
            const ageInput = document.getElementById('playerAge').value.trim();

            if (nameInput === "") {
                statusEl.textContent = "Kérem adja meg a játékos nevét!";
                statusEl.className = 'text-center text-red-500 my-4';
                return;
            }

            const age = ageInput === "" ? null : parseInt(ageInput, 10);

            const newPlayerDTO = {
                name: nameInput,
                age: age
            };

            statusEl.textContent = 'Játékos hozzáadása...';
            statusEl.className = 'text-center text-blue-600 my-4';

            try {
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newPlayerDTO)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`HTTP hiba: ${response.status} (${response.statusText}). Válasz: ${errorBody}`);
                }

                // A POST után kapott válasz is tartalmazza az új játékost, DE
                // mivel a Ktor WS-t küld, hagyjuk a WS-t frissíteni a playersData-t.
                // Itt csak a siker üzenetet jelezzük.

                statusEl.textContent = `Játékos "${nameInput}" sikeresen hozzáadva. (WS frissíti a listát)`;
                statusEl.className = 'text-center text-green-600 my-4 font-bold';

                form.reset();

            } catch (error) {
                console.error("Hiba a játékos hozzáadása során:", error);
                statusEl.textContent = `Hiba a játékos hozzáadása során: ${error.message}`;
                statusEl.className = 'text-center text-red-600 my-4 font-bold';
            }
        }

        /**
         * Játékos törlése DELETE kéréssel.
         */
        async function deletePlayer(id) {
            const playerName = playersData.find(p => p.id === id)?.name || id;

            if (!confirm(`Biztosan törölni szeretné a(z) "${playerName}" játékost (ID: ${id})?`)) {
                return;
            }

            const statusEl = document.getElementById('status');
            statusEl.textContent = `Játékos ${id} törlése...`;
            statusEl.className = 'text-center text-blue-600 my-4';

            try {
                // Törlés végpont hívása
                const response = await fetch(`${BACKEND_API_URL}/${id}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`HTTP hiba: ${response.status} (${response.statusText}). Válasz: ${errorBody}`);
                }

                // A Ktor küld egy WS eseményt PlayerDeleted-et, ami frissíti a listát.
                statusEl.textContent = `Játékos ${id} sikeresen törlésre került. (WS frissíti a listát)`;
                statusEl.className = 'text-center text-green-600 my-4 font-bold';

            } catch (error) {
                console.error("Hiba a játékos törlése során:", error);
                statusEl.textContent = `Hiba a törlés során: ${error.message}`;
                statusEl.className = 'text-center text-red-600 my-4 font-bold';
            }
        }

        /**
         * Megjeleníti a játékosadatokat a táblázatban a globális playersData lista alapján.
         * @param {Array<Object>} players - A játékosokat tartalmazó tömb.
         */
        function renderPlayers(players) {
            const playerTableBodyEl = document.getElementById('playerTableBody');
            if (!playerTableBodyEl) return;

            playerTableBodyEl.innerHTML = ''; // Előző tartalom törlése

            if (players.length === 0) {
                playerTableBodyEl.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">Nincsenek adatok az adatbázisban.</td></tr>';
                return;
            }

            // Rendezés ID alapján (az átláthatóság kedvéért)
            const sortedPlayers = [...players].sort((a, b) => a.id - b.id);

            sortedPlayers.forEach(player => {
                const row = playerTableBodyEl.insertRow();
                row.className = 'border-b hover:bg-indigo-50 transition duration-150';

                // ID
                let cell = row.insertCell();
                cell.textContent = player.id;
                cell.className = 'py-3 px-6 font-medium text-gray-900';

                // Név
                cell = row.insertCell();
                cell.textContent = player.name || 'N/A';
                cell.className = 'py-3 px-6 text-gray-700';

                // Életkor
                cell = row.insertCell();
                cell.textContent = player.age != null ? player.age : 'N/A';
                cell.className = 'py-3 px-6 text-gray-700';

                // Műveletek
                cell = row.insertCell();
                cell.className = 'py-3 px-6 flex space-x-2 justify-center';
                cell.innerHTML = `
                    <button onclick="alert('A Szerkesztés funkció még hiányzik!')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-1 px-3 rounded-md transition duration-150 text-sm">
                        Szerkesztés
                    </button>
                    <button onclick="deletePlayer(${player.id})" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md transition duration-150 text-sm">
                        Törlés
                    </button>
                `;
            });
        }

        // Amikor az oldal betöltődik, automatikusan töltse be az adatokat és indítsa a WS-t
        window.onload = () => {
            fetchPlayers();
            setupWebSocket();
        }

    </script>
</head>
<body class="p-4 md:p-8">

<div class="container-box mx-auto bg-white p-6 md:p-10 rounded-xl">
    <header class="mb-8 border-b pb-4 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-extrabold text-indigo-700">Rendszer Adminisztrációs Felület</h1>
            <p class="text-gray-500 mt-1">Játékos adatok kezelése a Docker konténerben futó backend segítségével.</p>
        </div>
        <div id="wsStatus" class="inline-flex items-center rounded-full bg-gray-200 px-3 py-0.5 text-sm font-medium text-gray-700">
            WS Kapcsolat
        </div>
    </header>

    <!-- Státusz üzenetek -->
    <div id="status" class="text-center text-gray-500 my-4"></div>

    <!-- JÁTÉKOS HOZZÁADÁSA ŰRLAP -->
    <section class="mb-8 p-6 bg-indigo-50 rounded-lg border border-indigo-200">
        <h2 class="text-xl font-semibold mb-4 text-indigo-700">Új Játékos Felvétele</h2>
        <form id="addPlayerForm" onsubmit="addPlayer(event)" class="space-y-4">
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                <div class="flex-1">
                    <label for="playerName" class="block text-sm font-medium text-gray-700">Név*</label>
                    <input type="text" id="playerName" name="playerName" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex-1">
                    <label for="playerAge" class="block text-sm font-medium text-gray-700">Életkor (Opcionális)</label>
                    <input type="number" id="playerAge" name="playerAge" min="1" max="150"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>

            <button type="submit"
                    class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                Játékos Hozzáadása
            </button>
        </form>
    </section>

    <!-- Játékoslista megjelenítése -->
    <section id="playerList" class="overflow-x-auto rounded-lg border border-gray-200 mt-8">
        <h2 class="text-xl font-semibold p-4 bg-gray-50 text-gray-700 border-b">Játékosok listája</h2>
        <div class="flex justify-end p-4 bg-gray-50">
            <button onclick="fetchPlayers()"
                    class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                Adatok Frissítése (HTTP)
            </button>
        </div>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="table-header">
            <tr>
                <th class="py-3 px-6 text-left text-sm font-semibold uppercase tracking-wider">ID</th>
                <th class="py-3 px-6 text-left text-sm font-semibold uppercase tracking-wider">Név</th>
                <th class="py-3 px-6 text-left text-sm font-semibold uppercase tracking-wider">Életkor</th>
                <th class="py-3 px-6 text-center text-sm font-semibold uppercase tracking-wider">Műveletek</th>
            </tr>
            </thead>
            <tbody id="playerTableBody" class="bg-white divide-y divide-gray-200">
            <!-- A játékos adatok ide kerülnek JS-sel -->
            </tbody>
        </table>
    </section>

</div>

</body>
</html>
